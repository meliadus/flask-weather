{% extends "base.html" %}
{% block content %}
<h1 class="mb-4">{{ 'Оформление заказа' if lang=='ru' else 'Checkout' }}</h1>

<div class="row g-4">

  <!-- Колонка: адрес/ревью -->
  <div class="col-lg-7">

    <!-- Шаг 1: форма адреса -->
    <div id="edit-step" class="card bg-dark text-light shadow">
      <div class="card-body">
        <h4 class="mb-3">{{ 'Адрес доставки' if lang=='ru' else 'Shipping address' }}</h4>

        <div id="ship-msg" class="alert alert-info d-none"></div>

        <form id="shipping-form" onsubmit="event.preventDefault(); goToReview();">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">{{ 'Имя' if lang=='ru' else 'First name' }}</label>
              <input class="form-control" name="first_name" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ 'Фамилия' if lang=='ru' else 'Last name' }}</label>
              <input class="form-control" name="last_name" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">{{ 'Страна' if lang=='ru' else 'Country' }}</label>
              <input class="form-control" name="country" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ 'Индекс' if lang=='ru' else 'Postcode' }}</label>
              <input class="form-control" name="postcode" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">{{ 'Город' if lang=='ru' else 'City' }}</label>
              <input class="form-control" name="city" required>
            </div>
            <div class="col-12">
              <label class="form-label">{{ 'Адрес 1' if lang=='ru' else 'Address line 1' }}</label>
              <input class="form-control" name="address1" required>
            </div>
            <div class="col-12">
              <label class="form-label">{{ 'Адрес 2 (необязательно)' if lang=='ru' else 'Address line 2 (optional)' }}</label>
              <input class="form-control" name="address2">
            </div>

            <div class="col-md-6">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" name="email" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">{{ 'Телефон' if lang=='ru' else 'Phone' }}</label>
              <input class="form-control" name="phone" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">{{ 'Перевозчик (необязательно)' if lang=='ru' else 'Carrier (optional)' }}</label>
              <input class="form-control" name="carrier">
            </div>
            <div class="col-12">
              <label class="form-label">{{ 'Примечания к доставке' if lang=='ru' else 'Delivery notes' }}</label>
              <textarea class="form-control" name="notes" rows="2"></textarea>
            </div>
          </div>

          <div class="d-flex gap-2 mt-4">
            <button class="btn btn-outline-secondary" type="button" onclick="saveShipping(true)">
              {{ 'Сохранить адрес' if lang=='ru' else 'Save address' }}
            </button>
            <button class="btn btn-primary" type="submit">
              {{ 'Просмотр и оплата' if lang=='ru' else 'Review & Pay' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Шаг 2: сводка + оплата -->
    <div id="review-step" class="card bg-dark text-light shadow d-none">
      <div class="card-body">
        <h4 class="mb-3">{{ 'Проверьте адрес' if lang=='ru' else 'Review your address' }}</h4>

        <div class="p-3 rounded border border-secondary mb-3 bg-opacity-50">
          <div id="review-address" style="white-space: pre-line;"></div>
        </div>

        <div class="d-flex gap-2 mb-4">
          <button class="btn btn-outline-light" onclick="backToEdit()">
            {{ 'Изменить адрес' if lang=='ru' else 'Edit address' }}
          </button>
        </div>

        <h5 class="mb-3">{{ 'Выберите способ оплаты' if lang=='ru' else 'Choose payment method' }}</h5>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-warning" onclick="proceedPayment('vipps')">Vipps</button>
          <button class="btn btn-primary" onclick="proceedPayment('revolut')">Revolut</button>
          <button class="btn btn-light"   onclick="proceedPayment('paypal')">PayPal</button>
        </div>
      </div>
    </div>

  </div>

  <!-- Колонка: корзина -->
  <div class="col-lg-5">
    <div class="card bg-dark text-light shadow">
      <div class="card-body">
        <h4 class="mb-3">{{ 'Ваш заказ' if lang=='ru' else 'Your order' }}</h4>

        {% if cart_items %}
          <ul class="list-group list-group-flush">
            {% for it in cart_items %}
              <li class="list-group-item bg-dark text-light d-flex justify-content-between">
                <div>
                  {{ (it['name_ru'] if lang=='ru' else it['name_en']) or it['name'] }} × {{ it.qty }}
                </div>
                <div>{{ it.subtotal }} NOK</div>
              </li>
            {% endfor %}
            <li class="list-group-item bg-dark text-light d-flex justify-content-between fw-bold">
              <span>{{ 'Итого' if lang=='ru' else 'Total' }}</span>
              <span>{{ total }} NOK</span>
            </li>
          </ul>
        {% else %}
          <p class="text-muted">{{ 'Корзина пуста' if lang=='ru' else 'Your cart is empty' }}</p>
        {% endif %}
      </div>
    </div>
  </div>

</div>

<script>
const lang = "{{ lang }}";
const saveUrl = "{{ url_for('save_shipping') }}";
const payUrls = {
  vipps: "{{ url_for('pay_vipps') }}",
  revolut: "{{ url_for('pay_revolut') }}",
  paypal: "{{ url_for('pay_paypal') }}"
};

function collectShipping() {
  const f = document.getElementById('shipping-form');
  const data = {
    first_name: f.first_name.value.trim(),
    last_name:  f.last_name.value.trim(),
    country:    f.country.value.trim(),
    postcode:   f.postcode.value.trim(),
    city:       f.city.value.trim(),
    address1:   f.address1.value.trim(),
    address2:   f.address2.value.trim(),
    email:      f.email.value.trim(),
    phone:      f.phone.value.trim(),
    carrier:    f.carrier.value.trim(),
    notes:      f.notes.value.trim(),
  };
  return data;
}

function fillFormFrom(obj) {
  const f = document.getElementById('shipping-form');
  for (const k in obj) { if (f[k]) f[k].value = obj[k] ?? ""; }
}

function renderReviewBox(data) {
  const lines = [];
  lines.push(`${data.first_name} ${data.last_name}`);
  lines.push(`${data.address1}${data.address2 ? ', ' + data.address2 : ''}`);
  lines.push(`${data.postcode} ${data.city}`);
  lines.push(data.country);
  lines.push(`${'Тел.' if (lang=='ru') else 'Phone'}: ${data.phone}`);
  lines.push(`Email: ${data.email}`);
  if (data.carrier) lines.push(`${(lang=='ru'?'Перевозчик':'Carrier')}: ${data.carrier}`);
  if (data.notes)   lines.push(`${(lang=='ru'?'Примечания':'Notes')}: ${data.notes}`);
  document.getElementById('review-address').textContent = lines.join('\n');
}

async function saveShipping(showToast=false) {
  const box = document.getElementById('ship-msg');
  const data = collectShipping();
  // простая валидация
  const required = ['first_name','last_name','country','postcode','city','address1','email','phone'];
  for (const k of required) {
    if (!data[k]) {
      if (showToast) {
        box.className = "alert alert-danger";
        box.textContent = (lang=='ru'?'Заполните обязательные поля':'Please fill in required fields');
        box.classList.remove('d-none');
      }
      return false;
    }
  }

  // локально
  localStorage.setItem('shipping', JSON.stringify(data));

  try {
    await fetch(saveUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    if (showToast) {
      box.className = "alert alert-success";
      box.textContent = (lang=='ru'?'Адрес сохранён':'Address saved');
      box.classList.remove('d-none');
      setTimeout(()=> box.classList.add('d-none'), 1500);
    }
    return true;
  } catch(e) {
    if (showToast) {
      box.className = "alert alert-warning";
      box.textContent = (lang=='ru'?'Не удалось сохранить адрес':'Failed to save address');
      box.classList.remove('d-none');
    }
    return false;
  }
}

async function goToReview() {
  const ok = await saveShipping(false);
  if (!ok) { saveShipping(true); return; }

  // показать сводку
  const data = collectShipping();
  renderReviewBox(data);

  document.getElementById('edit-step').classList.add('d-none');
  document.getElementById('review-step').classList.remove('d-none');
}

function backToEdit() {
  document.getElementById('review-step').classList.add('d-none');
  document.getElementById('edit-step').classList.remove('d-none');
}

async function proceedPayment(method) {
  const ok = await saveShipping(false);
  if (!ok) { saveShipping(true); return; }
  window.location.href = payUrls[method];
}

// Восстановление из session → в контекст уже подставляется сервером.
// Дополнительно — из localStorage (если серверной нет)
window.addEventListener('DOMContentLoaded', () => {
  {% if session.get('shipping') %}
    fillFormFrom({{ session.get('shipping')|tojson }});
  {% else %}
    const ls = localStorage.getItem('shipping');
    if (ls) fillFormFrom(JSON.parse(ls));
  {% endif %}
});

// На всякий случай, перед уходом сохраняем адрес
window.addEventListener('beforeunload', ()=>{ saveShipping(false); });
</script>
{% endblock %}
